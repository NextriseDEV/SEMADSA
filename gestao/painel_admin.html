<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão - SEMADSA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" href="https://nextrisedev.github.io/SEMADSA/ICONES.png">
    
    <script>
        // --- AUTH GUARD DE GESTOR ---
        const adminUser = JSON.parse(localStorage.getItem('semadsa_admin'));
        if(!adminUser || adminUser.tipo !== 'admin') {
            alert("Sessão Expirada. Faça login novamente.");
            window.location.href = '../login_admin.html';
        }
    </script>

    <style>
        /* Transições */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Badges */
        .badge-ativo { @apply bg-green-100 text-green-800 border border-green-200; }
        .badge-inativo { @apply bg-red-100 text-red-800 border border-red-200; }
        
        /* Menu Ativo */
        .nav-link.active { @apply bg-blue-800 text-white shadow-inner; }

        /* Overlay do Menu Mobile */
        #mobileOverlay { transition: opacity 0.3s ease; }
    </style>
</head>
<body class="bg-gray-50 font-sans h-screen flex overflow-hidden">

    <div id="mobileOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-20 hidden md:hidden glass transition-opacity"></div>

    <aside id="sidebar" class="fixed inset-y-0 left-0 w-64 bg-blue-900 text-blue-100 flex flex-col shadow-2xl z-30 transform -translate-x-full md:translate-x-0 md:static transition-transform duration-300 ease-in-out">
        <div class="p-6 border-b border-blue-800 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <img src="https://nextrisedev.github.io/SEMADSA/ICONES.png" class="w-8">
                <div>
                    <h1 class="font-bold text-lg text-white leading-none">SEMADSA</h1>
                    <span class="text-xs text-blue-300 block">Painel Gerencial</span>
                </div>
            </div>
            <button onclick="toggleSidebar()" class="md:hidden text-blue-300 hover:text-white">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
        </div>
        
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <button onclick="switchView('dashboard'); toggleSidebar()" id="nav-dashboard" class="nav-link w-full text-left px-4 py-3 rounded-lg font-bold transition hover:bg-blue-800 active flex items-center gap-3">
                <i class="fa-solid fa-chart-line"></i> Dashboard
            </button>
            <button onclick="switchView('contribuintes'); toggleSidebar()" id="nav-contribuintes" class="nav-link w-full text-left px-4 py-3 rounded-lg font-bold transition hover:bg-blue-800 flex items-center gap-3">
                <i class="fa-solid fa-users"></i> Contribuintes
            </button>

            <div id="masterAdminMenu" class="hidden mt-4 pt-4 border-t border-blue-800">
                <p class="px-4 text-xs font-bold text-blue-400 uppercase mb-2">Administração</p>
                <button onclick="openNewAdminModal(); toggleSidebar()" class="nav-link w-full text-left px-4 py-2 rounded-lg font-bold transition hover:bg-blue-800 flex items-center gap-3 text-sm">
                    <i class="fa-solid fa-user-plus"></i> Novo Gestor
                </button>
                <button onclick="switchView('gestores'); toggleSidebar()" id="nav-gestores" class="nav-link w-full text-left px-4 py-2 rounded-lg font-bold transition hover:bg-blue-800 flex items-center gap-3 text-sm">
                    <i class="fa-solid fa-user-shield"></i> Gerenciar Gestores
                </button>
            </div>
        </nav>

        <div class="p-4 bg-blue-950">
            <div class="flex items-center gap-2 mb-4 px-2">
                <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center font-bold text-white">
                    <i class="fa-solid fa-user-circle"></i>
                </div>
                <p class="text-sm truncate w-32 font-bold text-white" id="adminNameDisplay">Admin</p>
            </div>
            <button onclick="logoutAdmin()" class="w-full text-sm bg-red-600 hover:bg-red-700 text-white py-2 rounded transition flex items-center justify-center gap-2">
                <i class="fa-solid fa-power-off"></i> Sair
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden relative w-full">
        
        <header class="bg-white shadow-sm h-16 flex items-center justify-between px-4 md:px-8 z-10">
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()" class="md:hidden text-gray-600 hover:text-blue-900 text-xl focus:outline-none">
                    <i class="fa-solid fa-bars"></i>
                </button>
                <h2 class="text-lg md:text-xl font-bold text-gray-800 truncate" id="pageTitle">Visão Geral</h2>
            </div>
            
            <div class="flex items-center gap-4">
                <button onclick="triggerBroadcast()" class="bg-green-600 hover:bg-green-700 text-white px-3 md:px-4 py-2 rounded-full font-bold shadow-md transition flex items-center gap-2 text-xs md:text-sm">
                    <i class="fa-brands fa-whatsapp"></i> <span class="hidden md:inline">Disparar Avisos</span>
                </button>
            </div>
        </header>

        <div id="view-dashboard" class="flex-1 overflow-y-auto p-4 md:p-8 fade-in">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 md:gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500">
                    <p class="text-xs font-bold text-gray-400 uppercase">Total Arrecadado</p>
                    <p class="text-2xl font-bold text-blue-800" id="kpiTotal">R$ 0,00</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-indigo-500">
                    <p class="text-xs font-bold text-gray-400 uppercase">Contribuintes Ativos</p>
                    <p class="text-2xl font-bold text-indigo-800" id="kpiAtivos">0</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-red-400">
                    <p class="text-xs font-bold text-gray-400 uppercase">Inativos/Pendentes</p>
                    <p class="text-2xl font-bold text-red-600" id="kpiInativos">0</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500">
                    <p class="text-xs font-bold text-gray-400 uppercase">Meta (Estimada)</p>
                    <p class="text-2xl font-bold text-green-800">85%</p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm mb-8">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h3 class="font-bold text-gray-700 text-lg">Evolução Financeira</h3>
                    
                    <div class="flex flex-wrap gap-2 justify-center">
                        <button onclick="exportRevenueCSV()" class="bg-green-100 text-green-700 border border-green-200 px-3 py-1 rounded-lg text-xs font-bold hover:bg-green-200 flex items-center gap-2 transition">
                            <i class="fa-solid fa-file-excel"></i> Relatório
                        </button>
                        
                        <div class="flex bg-gray-100 p-1 rounded-lg overflow-x-auto">
                            <button onclick="updateChartFilter('mensal')" class="filter-btn px-3 py-1 rounded-md text-xs font-bold bg-white shadow text-blue-600" id="btn-mensal">Mensal</button>
                            <button onclick="updateChartFilter('trimestral')" class="filter-btn px-3 py-1 rounded-md text-xs font-bold text-gray-500 hover:bg-white" id="btn-trimestral">Trim.</button>
                            <button onclick="updateChartFilter('semestral')" class="filter-btn px-3 py-1 rounded-md text-xs font-bold text-gray-500 hover:bg-white" id="btn-semestral">Sem.</button>
                            <button onclick="updateChartFilter('anual')" class="filter-btn px-3 py-1 rounded-md text-xs font-bold text-gray-500 hover:bg-white" id="btn-anual">Anual</button>
                        </div>
                    </div>
                </div>
                <div class="h-64">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm">
                <h3 class="font-bold text-gray-700 mb-4">Últimos Cadastros</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm min-w-[500px]">
                        <thead class="bg-gray-50 text-gray-500 border-b">
                            <tr><th class="p-3">Nome</th><th class="p-3 text-right">Contato</th></tr>
                        </thead>
                        <tbody id="recentTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-contribuintes" class="hidden flex-1 flex flex-col p-4 md:p-8 fade-in h-full overflow-hidden">
            <div class="bg-white p-4 rounded-xl shadow-sm mb-4 flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="relative w-full md:w-96">
                    <i class="fa-solid fa-search absolute left-3 top-3 text-gray-400"></i>
                    <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Buscar por Nome, CPF ou Email..." class="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                </div>
                <div class="flex gap-2 w-full md:w-auto">
                    <button onclick="exportCSV()" class="flex-1 md:flex-none bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold text-sm shadow flex items-center justify-center gap-2">
                        <i class="fa-solid fa-file-csv"></i> Exportar
                    </button>
                    <button onclick="loadContributors()" class="flex-1 md:flex-none bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold text-sm shadow flex items-center justify-center gap-2">
                        <i class="fa-solid fa-rotate"></i> Atualizar
                    </button>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm flex-1 overflow-hidden flex flex-col">
                <div class="overflow-y-auto flex-1">
                    <table class="w-full text-left text-sm min-w-[800px]">
                        <thead class="bg-gray-100 text-gray-600 uppercase font-bold sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th class="p-4 w-1/3">Nome</th>
                                <th class="p-4">CPF</th>
                                <th class="p-4">Contato</th>
                                <th class="p-4 text-center">Status</th>
                                <th class="p-4 text-right">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="contributorsTableBody" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
                <div class="bg-gray-50 p-2 text-center text-xs text-gray-400 border-t">Mostrando <span id="countDisplay">0</span> registros</div>
            </div>
        </div>

        <div id="view-gestores" class="hidden flex-1 flex flex-col p-4 md:p-8 fade-in h-full overflow-hidden">
            <div class="bg-white p-4 rounded-xl shadow-sm mb-4 flex justify-between items-center gap-4">
                <h3 class="text-lg font-bold text-gray-700">Controle de Acesso</h3>
                <button onclick="openNewAdminModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-bold text-sm shadow flex items-center gap-2">
                    <i class="fa-solid fa-plus"></i> Novo Gestor
                </button>
            </div>
            <div class="bg-white rounded-xl shadow-sm flex-1 overflow-hidden flex flex-col">
                <div class="overflow-y-auto flex-1">
                    <table class="w-full text-left text-sm min-w-[600px]">
                        <thead class="bg-gray-100 text-gray-600 uppercase font-bold sticky top-0 z-10 shadow-sm">
                            <tr><th class="p-4">Nome</th><th class="p-4">Login</th><th class="p-4 text-center">Status</th><th class="p-4 text-right">Ações</th></tr>
                        </thead>
                        <tbody id="managersTableBody" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <div id="modalNewAdmin" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all scale-100">
            <div class="bg-blue-900 p-4 flex justify-between items-center">
                <h3 class="text-white font-bold flex items-center gap-2"><i class="fa-solid fa-user-shield"></i> Cadastrar Gestor</h3>
                <button onclick="closeNewAdminModal()" class="text-blue-300 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <form onsubmit="handleRegisterAdmin(event)" class="p-6 space-y-4">
                <div><label class="text-xs font-bold text-gray-600 uppercase">Nome</label><input type="text" id="adminNome" required class="w-full p-2 border rounded focus:border-blue-500 outline-none"></div>
                <div><label class="text-xs font-bold text-gray-600 uppercase">Login</label><input type="text" id="adminLogin" required class="w-full p-2 border rounded focus:border-blue-500 outline-none"></div>
                <div><label class="text-xs font-bold text-gray-600 uppercase">Senha</label><input type="password" id="adminSenha" required class="w-full p-2 border rounded focus:border-blue-500 outline-none"></div>
                <button type="submit" id="btnSaveAdmin" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow transition">CADASTRAR</button>
            </form>
        </div>
    </div>

<script>
    // ⚠️ SUBSTITUA PELA SUA URL DEPLOY
    const API_URL = 'https://script.google.com/macros/s/AKfycbx4eQLrogacDoirc1yrM20rWc0Hi4AbeLXrcKHZedgXmDPr_tH3uBaBzryzD_uTR-wDqQ/exec';
    
    let chartInstance = null;
    let globalChartData = {};
    let globalContributors = [];

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('adminNameDisplay').innerText = adminUser.nome;
        
        if(adminUser.login === 'admin') {
            document.getElementById('masterAdminMenu').classList.remove('hidden');
        }

        loadDashboardData();
    });

    // --- TOGGLE SIDEBAR MOBILE ---
    function toggleSidebar() {
        const sb = document.getElementById('sidebar');
        const ov = document.getElementById('mobileOverlay');
        const isClosed = sb.classList.contains('-translate-x-full');
        
        if (isClosed) {
            sb.classList.remove('-translate-x-full');
            ov.classList.remove('hidden');
        } else {
            sb.classList.add('-translate-x-full');
            ov.classList.add('hidden');
        }
    }

    // --- NAVEGAÇÃO SPA ---
    function switchView(viewName) {
        // Esconde tudo
        ['dashboard', 'contribuintes', 'gestores'].forEach(v => {
            const el = document.getElementById('view-' + v);
            const nav = document.getElementById('nav-' + v);
            if(el) el.classList.add('hidden');
            if(nav) nav.classList.remove('active', 'bg-blue-800', 'shadow-inner');
        });

        // Mostra selecionado
        const targetView = document.getElementById('view-' + viewName);
        const targetNav = document.getElementById('nav-' + viewName);
        
        if(targetView) targetView.classList.remove('hidden');
        if(targetNav) targetNav.classList.add('active', 'bg-blue-800', 'shadow-inner');

        const titles = { 'dashboard': 'Visão Geral', 'contribuintes': 'Gestão de Contribuintes', 'gestores': 'Gestão de Acesso' };
        document.getElementById('pageTitle').innerText = titles[viewName] || 'Painel';

        if(viewName === 'contribuintes' && globalContributors.length === 0) loadContributors();
        if(viewName === 'gestores') loadManagers();
    }

    // --- DASHBOARD & CHART ---
    async function loadDashboardData() {
        try {
            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'getAdminData' }) });
            const data = await res.json();
            if(data.status === 'success') {
                document.getElementById('kpiTotal').innerText = Number(data.kpis.total).toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
                document.getElementById('kpiAtivos').innerText = data.kpis.ativos;
                document.getElementById('kpiInativos').innerText = data.kpis.inativos;
                
                const recentBody = document.getElementById('recentTableBody');
                recentBody.innerHTML = '';
                data.recentes.forEach(u => {
                    recentBody.innerHTML += `<tr class="border-b last:border-0 hover:bg-gray-50"><td class="p-3 font-bold text-gray-700">${u.nome}</td><td class="p-3 text-right text-green-600"><i class="fa-brands fa-whatsapp"></i> ${u.whatsapp}</td></tr>`;
                });
                globalChartData = data.chartData;
                updateChartFilter('mensal');
            }
        } catch (e) { console.error(e); }
    }

    function updateChartFilter(period) {
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('bg-white', 'text-blue-600', 'shadow');
            btn.classList.add('text-gray-500');
        });
        document.getElementById('btn-' + period).classList.add('bg-white', 'text-blue-600', 'shadow');
        document.getElementById('btn-' + period).classList.remove('text-gray-500');
        renderChart(period);
    }

    function renderChart(period) {
        const ctx = document.getElementById('revenueChart').getContext('2d');
        const currentYear = new Date().getFullYear();
        const dataYear = globalChartData[currentYear] || Array(12).fill(0);
        let labels = [], values = [];

        if (period === 'mensal') {
            labels = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"]; values = dataYear;
        } else if (period === 'trimestral') {
            labels = ["1º Trim", "2º Trim", "3º Trim", "4º Trim"];
            values = [(dataYear[0]+dataYear[1]+dataYear[2]), (dataYear[3]+dataYear[4]+dataYear[5]), (dataYear[6]+dataYear[7]+dataYear[8]), (dataYear[9]+dataYear[10]+dataYear[11])];
        } else if (period === 'semestral') {
            labels = ["1º Semestre", "2º Semestre"];
            values = [dataYear.slice(0, 6).reduce((a,b)=>a+b, 0), dataYear.slice(6, 12).reduce((a,b)=>a+b, 0)];
        } else if (period === 'anual') {
            labels = Object.keys(globalChartData).sort(); values = labels.map(ano => globalChartData[ano].reduce((a,b)=>a+b, 0));
        }

        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: { labels: labels, datasets: [{ label: 'Arrecadação (R$)', data: values, backgroundColor: '#2563eb', borderRadius: 6, barPercentage: 0.6 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { borderDash: [2, 2] }, ticks: { callback: (value) => 'R$ ' + value } }, x: { grid: { display: false } } } }
        });
    }

    // --- CONTRIBUINTES (Com Botão WhatsApp corrigido) ---
    async function loadContributors() {
        const tbody = document.getElementById('contributorsTableBody');
        tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-500"><i class="fa-solid fa-spinner fa-spin"></i> Atualizando...</td></tr>';
        try {
            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'getContributorsList' }) });
            const data = await res.json();
            if(data.status === 'success') {
                globalContributors = data.lista;
                renderTable(globalContributors);
            }
        } catch(e) { console.error(e); }
    }

    function renderTable(data) {
        const tbody = document.getElementById('contributorsTableBody');
        tbody.innerHTML = '';
        document.getElementById('countDisplay').innerText = data.length;
        if(data.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-400">Nenhum registro.</td></tr>'; return; }

        data.forEach(u => {
            const statusClass = u.status === 'ATIVO' ? 'badge-ativo' : 'badge-inativo';
            const btnAction = u.status === 'ATIVO' 
                ? `<button onclick="toggleStatus('${u.id}', 'INATIVO')" class="text-red-500 hover:bg-red-50 p-2 rounded transition" title="Inativar"><i class="fa-solid fa-ban"></i></button>`
                : `<button onclick="toggleStatus('${u.id}', 'ATIVO')" class="text-green-600 hover:bg-green-50 p-2 rounded" title="Ativar"><i class="fa-solid fa-check"></i></button>`;
            
            // Limpa o telefone para o link
            const cleanPhone = String(u.whatsapp).replace(/\D/g, '');

            tbody.innerHTML += `
                <tr class="hover:bg-blue-50/50 transition border-b border-gray-50 group">
                    <td class="p-4 font-bold text-gray-700">${u.nome}</td>
                    <td class="p-4 text-gray-500">${u.cpf || '-'}</td>
                    <td class="p-4"><div class="text-xs text-gray-500">${u.whatsapp}</div></td>
                    <td class="p-4 text-center"><span class="px-3 py-1 rounded-full text-xs font-bold ${statusClass}">${u.status}</span></td>
                    <td class="p-4 text-right">
                        <div class="flex items-center justify-end gap-2">
                            ${btnAction}
                            <button onclick="window.open('https://wa.me/55${cleanPhone}', '_blank')" class="bg-green-100 text-green-600 hover:bg-green-200 p-2 rounded-lg transition ml-2 shadow-sm border border-green-200" title="Chamar no WhatsApp">
                                <i class="fa-brands fa-whatsapp text-lg"></i>
                            </button>
                        </div>
                    </td>
                </tr>`;
        });
    }

    function filterTable() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const filtered = globalContributors.filter(u => String(u.nome).toLowerCase().includes(term) || String(u.cpf).includes(term));
        renderTable(filtered);
    }

    async function toggleStatus(id, newStatus) {
        if(!confirm(`Mudar status para ${newStatus}?`)) return;
        const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'updateUserStatus', id: id, newStatus: newStatus }) });
        const data = await res.json();
        if(data.status === 'success') loadContributors();
        else alert(data.message);
    }

    function exportCSV() {
        let csvContent = "data:text/csv;charset=utf-8,Nome,CPF,Email,WhatsApp,Status\n";
        globalContributors.forEach(row => { csvContent += `"${row.nome}","'${row.cpf}","${row.email}","${row.whatsapp}","${row.status}"\n`; });
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "contribuintes.csv");
        document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }

    // --- RELATÓRIO FINANCEIRO ---
    async function exportRevenueCSV() {
        if(!confirm("Baixar relatório completo?")) return;
        try {
            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'getRevenueReport' }) });
            const data = await res.json();
            if(data.status === 'success') {
                if(data.lista.length === 0) { alert("Sem dados."); return; }
                let csvContent = "data:text/csv;charset=utf-8,Contribuinte,Data,Mes,Ano,Status,Valor\n";
                data.lista.forEach(row => {
                    let dataFmt = row.data ? new Date(row.data).toLocaleDateString('pt-BR') : '-';
                    let valorFmt = parseFloat(row.valor).toFixed(2).replace('.', ','); 
                    csvContent += `"${row.contribuinte}","${dataFmt}","${row.mes}","${row.ano}","${row.status}","${valorFmt}"\n`;
                });
                const link = document.createElement("a");
                link.setAttribute("href", encodeURI(csvContent));
                link.setAttribute("download", "arrecadacao_semadsa.csv");
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
            }
        } catch(e) { alert("Erro ao baixar."); }
    }

    // --- GESTÃO DE GESTORES ---
    async function loadManagers() {
        const tbody = document.getElementById('managersTableBody');
        tbody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-gray-500">Carregando...</td></tr>';
        const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'getManagersList' }) });
        const data = await res.json();
        tbody.innerHTML = '';
        if(data.status === 'success') {
            data.lista.forEach(m => {
                const statusClass = m.status === 'ATIVO' ? 'badge-ativo' : 'badge-inativo';
                const isMaster = m.login === 'admin';
                const actionBtn = isMaster ? '<span class="text-xs text-gray-400">Master</span>' : 
                    (m.status === 'ATIVO' 
                    ? `<button onclick="toggleManagerStatus('${m.id}', 'INATIVO')" class="text-red-500 hover:bg-red-50 p-2 rounded" title="Inativar"><i class="fa-solid fa-ban"></i></button>`
                    : `<button onclick="toggleManagerStatus('${m.id}', 'ATIVO')" class="text-green-600 hover:bg-green-50 p-2 rounded" title="Ativar"><i class="fa-solid fa-check"></i></button>`);

                tbody.innerHTML += `
                    <tr class="border-b last:border-0 hover:bg-gray-50">
                        <td class="p-4 font-bold text-gray-700">${m.nome}</td>
                        <td class="p-4 text-gray-500">${m.login}</td>
                        <td class="p-4 text-center"><span class="px-3 py-1 rounded-full text-xs font-bold ${statusClass}">${m.status}</span></td>
                        <td class="p-4 text-right">${actionBtn}</td>
                    </tr>`;
            });
        }
    }

    async function toggleManagerStatus(id, newStatus) {
        if(!confirm(`Alterar status do gestor para ${newStatus}?`)) return;
        const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'updateManagerStatus', id: id, newStatus: newStatus }) });
        const data = await res.json();
        if(data.status === 'success') loadManagers();
        else alert(data.message);
    }

    function openNewAdminModal() { document.getElementById('modalNewAdmin').classList.remove('hidden'); }
    function closeNewAdminModal() { document.getElementById('modalNewAdmin').classList.add('hidden'); }

    async function handleRegisterAdmin(e) {
        e.preventDefault();
        const btn = document.getElementById('btnSaveAdmin');
        btn.innerText = "Salvando..."; btn.disabled = true;
        
        const payload = {
            action: 'registerNewAdmin',
            nome: document.getElementById('adminNome').value,
            login: document.getElementById('adminLogin').value,
            senha: document.getElementById('adminSenha').value
        };
        const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
        const data = await res.json();
        
        if(data.status === 'success') {
            alert("Gestor criado!");
            closeNewAdminModal();
            if(!document.getElementById('view-gestores').classList.contains('hidden')) loadManagers();
        } else {
            alert(data.message);
        }
        btn.innerText = "CADASTRAR"; btn.disabled = false;
    }

    function logoutAdmin() {
        if(confirm("Sair do painel?")) {
            localStorage.removeItem('semadsa_admin');
            window.location.href = '../login_admin.html';
        }
    }
    function triggerBroadcast() { if(confirm("Iniciar disparo?")) alert("Iniciado."); }
</script>
</body>
</html>
