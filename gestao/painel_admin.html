<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão - SEMADSA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" href="https://nextrisedev.github.io/SEMADSA/ICONES.png">
    
    <script>
        // --- AUTH GUARD DE GESTOR ---
        const adminUser = JSON.parse(localStorage.getItem('semadsa_admin'));
        if(!adminUser || adminUser.tipo !== 'admin') {
            alert("Sessão Expirada. Faça login novamente.");
            window.location.href = '../login_admin.html';
        }
    </script>

    <style>
        /* Transições */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Badges */
        .badge-ativo { background-color: #dcfce7; color: #166534; border: 1px solid #bbf7d0; } /* green */
        .badge-inativo { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; } /* red */
        
        /* Menu Ativo */
        .nav-link.active { background-color: #1e40af; color: white; box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.2); }
    </style>
</head>
<body class="bg-gray-50 font-sans h-screen flex overflow-hidden">

    <aside class="w-64 bg-blue-900 text-blue-100 flex flex-col shadow-2xl z-20">
        <div class="p-6 border-b border-blue-800 flex items-center gap-3">
            <img src="https://nextrisedev.github.io/SEMADSA/ICONES.png" class="w-8">
            <div>
                <h1 class="font-bold text-lg text-white leading-none">SEMADSA</h1>
                <span class="text-xs text-blue-300 block">Painel Gerencial</span>
            </div>
        </div>
        
        <nav class="flex-1 p-4 space-y-2">
            <button onclick="switchView('dashboard')" id="nav-dashboard" class="nav-link w-full text-left px-4 py-3 rounded-lg font-bold transition hover:bg-blue-800 active flex items-center gap-3">
                <i class="fa-solid fa-chart-line"></i> Dashboard
            </button>
            <button onclick="switchView('contribuintes')" id="nav-contribuintes" class="nav-link w-full text-left px-4 py-3 rounded-lg font-bold transition hover:bg-blue-800 flex items-center gap-3">
                <i class="fa-solid fa-users"></i> Contribuintes
                <button onclick="switchView('contribuintes')" id="nav-contribuintes" class="nav-link w-full text-left px-4 py-3 rounded-lg font-bold transition hover:bg-blue-800 flex items-center gap-3">
                <i class="fa-solid fa-users"></i> Contribuintes
            </button>
            
            <div class="mt-4 pt-4 border-t border-blue-800">
                <p class="px-4 text-xs font-bold text-blue-400 uppercase mb-2">Administração</p>
                <button onclick="openNewAdminModal()" class="nav-link w-full text-left px-4 py-2 rounded-lg font-bold transition hover:bg-blue-800 flex items-center gap-3 text-sm">
                    <i class="fa-solid fa-user-plus"></i> Novo Gestor
                </button>
            </div>
            </button>
        </nav>

        <div class="p-4 bg-blue-950">
            <div class="flex items-center gap-2 mb-4 px-2">
                <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center font-bold text-white">
                    <i class="fa-solid fa-user-shield"></i>
                </div>
                <p class="text-sm truncate w-32 font-bold text-white" id="adminNameDisplay">Admin</p>
            </div>
            <button onclick="logoutAdmin()" class="w-full text-sm bg-red-600 hover:bg-red-700 text-white py-2 rounded transition flex items-center justify-center gap-2">
                <i class="fa-solid fa-power-off"></i> Sair
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden relative">
        
        <header class="bg-white shadow-sm h-16 flex items-center justify-between px-8 z-10">
            <h2 class="text-xl font-bold text-gray-800" id="pageTitle">Visão Geral</h2>
            <div class="flex items-center gap-4">
                <button onclick="triggerBroadcast()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-full font-bold shadow-md transition flex items-center gap-2 text-sm">
                    <i class="fa-brands fa-whatsapp"></i> Disparar Avisos
                </button>
            </div>
        </header>

        <div id="view-dashboard" class="flex-1 overflow-y-auto p-8 fade-in">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500">
                    <p class="text-xs font-bold text-gray-400 uppercase">Total Arrecadado</p>
                    <p class="text-2xl font-bold text-blue-800" id="kpiTotal">R$ 0,00</p>
                    <div class="bg-white p-6 rounded-xl shadow-sm mb-8">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                    <h3 class="font-bold text-gray-700 text-lg">Evolução Financeira</h3>
                    
                    <div class="flex gap-2">
                        <button onclick="exportRevenueCSV()" class="bg-green-100 text-green-700 border border-green-200 px-3 py-1 rounded-lg text-xs font-bold hover:bg-green-200 flex items-center gap-2 transition">
                            <i class="fa-solid fa-file-excel"></i> Relatório Arrecadação
                        </button>
                        
                        <div class="flex bg-gray-100 p-1 rounded-lg">
                            <button onclick="updateChartFilter('mensal')" class="filter-btn px-4 py-1 rounded-md text-xs font-bold bg-white shadow text-blue-600" id="btn-mensal">Mensal</button>
                            </div>
                    </div>
                </div>
                <div class="h-64">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-indigo-500">
                    <p class="text-xs font-bold text-gray-400 uppercase">Contribuintes Ativos</p>
                    <p class="text-2xl font-bold text-indigo-800" id="kpiAtivos">0</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-red-400">
                    <p class="text-xs font-bold text-gray-400 uppercase">Inativos/Pendentes</p>
                    <p class="text-2xl font-bold text-red-600" id="kpiInativos">0</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500">
                    <p class="text-xs font-bold text-gray-400 uppercase">Meta (Estimada)</p>
                    <p class="text-2xl font-bold text-green-800">85%</p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm mb-8">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                    <h3 class="font-bold text-gray-700 text-lg">Evolução Financeira</h3>
                    <div class="flex bg-gray-100 p-1 rounded-lg">
                        <button onclick="updateChartFilter('mensal')" class="filter-btn px-4 py-1 rounded-md text-xs font-bold bg-white shadow text-blue-600" id="btn-mensal">Mensal</button>
                        <button onclick="updateChartFilter('trimestral')" class="filter-btn px-4 py-1 rounded-md text-xs font-bold text-gray-500 hover:bg-white" id="btn-trimestral">Trimestral</button>
                        <button onclick="updateChartFilter('semestral')" class="filter-btn px-4 py-1 rounded-md text-xs font-bold text-gray-500 hover:bg-white" id="btn-semestral">Semestral</button>
                        <button onclick="updateChartFilter('anual')" class="filter-btn px-4 py-1 rounded-md text-xs font-bold text-gray-500 hover:bg-white" id="btn-anual">Anual</button>
                    </div>
                </div>
                <div class="h-64">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm">
                <h3 class="font-bold text-gray-700 mb-4">Últimos Cadastros</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 text-gray-500 border-b">
                            <tr>
                                <th class="p-3">Nome</th>
                                <th class="p-3 text-right">Contato</th>
                            </tr>
                        </thead>
                        <tbody id="recentTableBody">
                            <tr><td colspan="2" class="p-4 text-center text-gray-400">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-contribuintes" class="hidden flex-1 flex flex-col p-8 fade-in h-full overflow-hidden">
            
            <div class="bg-white p-4 rounded-xl shadow-sm mb-4 flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="relative w-full md:w-96">
                    <i class="fa-solid fa-search absolute left-3 top-3 text-gray-400"></i>
                    <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Buscar por Nome, CPF ou Email..." 
                           class="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                </div>
                <div class="flex gap-2">
                    <button onclick="exportCSV()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold text-sm shadow flex items-center gap-2">
                        <i class="fa-solid fa-file-csv"></i> Exportar
                    </button>
                    <button onclick="loadContributors()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold text-sm shadow flex items-center gap-2">
                        <i class="fa-solid fa-rotate"></i> Atualizar
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm flex-1 overflow-hidden flex flex-col">
                <div class="overflow-y-auto flex-1">
                    <table class="w-full text-left text-sm" id="fullTable">
                        <thead class="bg-gray-100 text-gray-600 uppercase font-bold sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th class="p-4 w-1/4">Nome</th>
                                <th class="p-4">CPF</th>
                                <th class="p-4">Contato</th>
                                <th class="p-4 text-center">Status</th>
                                <th class="p-4 text-right">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="contributorsTableBody" class="divide-y divide-gray-100">
                            <tr><td colspan="5" class="p-8 text-center text-gray-500"><i class="fa-solid fa-spinner fa-spin"></i> Carregando dados...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="bg-gray-50 p-2 text-center text-xs text-gray-400 border-t">
                    Mostrando <span id="countDisplay">0</span> registros
                </div>
            </div>
        </div>

    </main>
    <div id="modalNewAdmin" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all scale-100">
            <div class="bg-blue-900 p-4 flex justify-between items-center">
                <h3 class="text-white font-bold flex items-center gap-2">
                    <i class="fa-solid fa-user-shield"></i> Cadastrar Gestor
                </h3>
                <button onclick="closeNewAdminModal()" class="text-blue-300 hover:text-white transition">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            <form onsubmit="handleRegisterAdmin(event)" class="p-6 space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-600 uppercase">Nome do Gestor</label>
                    <input type="text" id="adminNome" required class="w-full p-2 border rounded focus:border-blue-500 outline-none">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-600 uppercase">Usuário de Login</label>
                    <input type="text" id="adminLogin" required class="w-full p-2 border rounded focus:border-blue-500 outline-none" placeholder="ex: admin.financeiro">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-600 uppercase">Senha de Acesso</label>
                    <input type="password" id="adminSenha" required class="w-full p-2 border rounded focus:border-blue-500 outline-none">
                </div>
                <button type="submit" id="btnSaveAdmin" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow transition">
                    CADASTRAR ACESSO
                </button>
            </form>
        </div>
    </div>

<script>
    // ⚠️ ATENÇÃO: SUBSTITUA PELA SUA URL DEPLOY
    const API_URL = 'https://script.google.com/macros/s/AKfycbx4eQLrogacDoirc1yrM20rWc0Hi4AbeLXrcKHZedgXmDPr_tH3uBaBzryzD_uTR-wDqQ/exec';
    
    let chartInstance = null;
    let globalChartData = {}; 
    let globalContributors = []; 

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('adminNameDisplay').innerText = adminUser.nome;
        loadDashboardData();
    });

    // --- NAVEGAÇÃO SPA ---
    function switchView(viewName) {
        document.getElementById('view-dashboard').classList.add('hidden');
        document.getElementById('view-contribuintes').classList.add('hidden');
        
        document.getElementById('nav-dashboard').classList.remove('active', 'bg-blue-800', 'shadow-inner');
        document.getElementById('nav-contribuintes').classList.remove('active', 'bg-blue-800', 'shadow-inner');

        document.getElementById('view-' + viewName).classList.remove('hidden');
        document.getElementById('nav-' + viewName).classList.add('active', 'bg-blue-800', 'shadow-inner');
        
        document.getElementById('pageTitle').innerText = viewName === 'dashboard' ? 'Visão Geral' : 'Gestão de Contribuintes';

        if(viewName === 'contribuintes' && globalContributors.length === 0) {
            loadContributors();
        }
    }

    // --- DASHBOARD ---
    async function loadDashboardData() {
        try {
            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'getAdminData' }) });
            const data = await res.json();

            if(data.status === 'success') {
                document.getElementById('kpiTotal').innerText = Number(data.kpis.total).toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
                document.getElementById('kpiAtivos').innerText = data.kpis.ativos;
                document.getElementById('kpiInativos').innerText = data.kpis.inativos;

                const recentBody = document.getElementById('recentTableBody');
                recentBody.innerHTML = '';
                if(data.recentes.length === 0) recentBody.innerHTML = '<tr><td colspan="2" class="p-3 text-center text-gray-400">Nenhum cadastro recente.</td></tr>';
                
                data.recentes.forEach(u => {
                    recentBody.innerHTML += `
                        <tr class="border-b last:border-0 hover:bg-gray-50">
                            <td class="p-3 font-bold text-gray-700">${u.nome}</td>
                            <td class="p-3 text-right text-green-600"><i class="fa-brands fa-whatsapp"></i> ${u.whatsapp}</td>
                        </tr>`;
                });

                globalChartData = data.chartData;
                updateChartFilter('mensal');
            } else {
                console.error("Erro dados:", data.message);
            }
        } catch (e) {
            console.error(e);
            // Ignora erro silenciosamente no dashboard para não travar a UX, mostra só no console
        }
    }

    // --- GRÁFICO ---
    function updateChartFilter(period) {
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('bg-white', 'text-blue-600', 'shadow');
            btn.classList.add('text-gray-500');
        });
        document.getElementById('btn-' + period).classList.add('bg-white', 'text-blue-600', 'shadow');
        document.getElementById('btn-' + period).classList.remove('text-gray-500');

        renderChart(period);
    }

    function renderChart(period) {
        const ctx = document.getElementById('revenueChart').getContext('2d');
        const currentYear = new Date().getFullYear();
        const dataYear = globalChartData[currentYear] || Array(12).fill(0); 

        let labels = [], values = [];

        if (period === 'mensal') {
            labels = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
            values = dataYear;
        } 
        else if (period === 'trimestral') {
            labels = ["1º Trim", "2º Trim", "3º Trim", "4º Trim"];
            values = [
                (dataYear[0]+dataYear[1]+dataYear[2]), (dataYear[3]+dataYear[4]+dataYear[5]),
                (dataYear[6]+dataYear[7]+dataYear[8]), (dataYear[9]+dataYear[10]+dataYear[11])
            ];
        }
        else if (period === 'semestral') {
            labels = ["1º Semestre", "2º Semestre"];
            values = [
                dataYear.slice(0, 6).reduce((a,b)=>a+b, 0),
                dataYear.slice(6, 12).reduce((a,b)=>a+b, 0)
            ];
        }
        else if (period === 'anual') {
            labels = Object.keys(globalChartData).sort();
            values = labels.map(ano => globalChartData[ano].reduce((a,b)=>a+b, 0));
        }

        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Arrecadação (R$)',
                    data: values,
                    backgroundColor: '#2563eb',
                    borderRadius: 6,
                    barPercentage: 0.6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { 
                        beginAtZero: true, 
                        grid: { borderDash: [2, 2] },
                        ticks: { callback: (value) => 'R$ ' + value }
                    },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    // --- LISTA DE CONTRIBUINTES ---
    async function loadContributors() {
        const tbody = document.getElementById('contributorsTableBody');
        tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-500"><i class="fa-solid fa-spinner fa-spin"></i> Atualizando lista...</td></tr>';

        try {
            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'getContributorsList' }) });
            const data = await res.json();

            if(data.status === 'success') {
                globalContributors = data.lista;
                renderTable(globalContributors);
            } else {
                tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-red-500">Erro: ' + data.message + '</td></tr>';
            }
        } catch(e) {
            console.error(e);
            alert("Erro de conexão ao buscar lista.");
        }
    }

    function renderTable(data) {
        const tbody = document.getElementById('contributorsTableBody');
        tbody.innerHTML = '';
        document.getElementById('countDisplay').innerText = data.length;

        if(data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-400">Nenhum registro encontrado.</td></tr>';
            return;
        }

        data.forEach(u => {
            const statusClass = u.status === 'ATIVO' ? 'badge-ativo' : 'badge-inativo';
            const btnIcon = u.status === 'ATIVO' ? 'fa-ban' : 'fa-check';
            const btnColor = u.status === 'ATIVO' ? 'text-red-500 hover:bg-red-50' : 'text-green-600 hover:bg-green-50';
            const btnTitle = u.status === 'ATIVO' ? 'Inativar' : 'Ativar';
            const nextStatus = u.status === 'ATIVO' ? 'INATIVO' : 'ATIVO';

            tbody.innerHTML += `
                <tr class="hover:bg-blue-50/50 transition border-b border-gray-50 group">
                    <td class="p-4 font-bold text-gray-700">${u.nome}</td>
                    <td class="p-4 text-gray-500">${u.cpf || '-'}</td>
                    <td class="p-4">
                        <div class="text-xs text-gray-500">
                            <div class="flex items-center gap-1 mb-1"><i class="fa-solid fa-envelope text-gray-400"></i> ${u.email}</div>
                            <div class="flex items-center gap-1"><i class="fa-brands fa-whatsapp text-green-500"></i> ${u.whatsapp}</div>
                        </div>
                    </td>
                    <td class="p-4 text-center">
                        <span class="px-3 py-1 rounded-full text-xs font-bold ${statusClass}">${u.status}</span>
                    </td>
                    <td class="p-4 text-right">
                        <button onclick="toggleStatus('${u.id}', '${nextStatus}')" class="${btnColor} p-2 rounded transition" title="${btnTitle}">
                            <i class="fa-solid ${btnIcon}"></i>
                        </button>
                        <button onclick="window.open('https://wa.me/55${String(u.whatsapp).replace(/\D/g,'')}', '_blank')" class="text-blue-500 hover:bg-blue-50 p-2 rounded transition ml-1" title="Mensagem">
                            <i class="fa-brands fa-whatsapp"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
    }

    function filterTable() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const filtered = globalContributors.filter(u => 
            String(u.nome).toLowerCase().includes(term) || 
            String(u.cpf).includes(term) ||
            String(u.email).toLowerCase().includes(term)
        );
        renderTable(filtered);
    }

    async function toggleStatus(id, newStatus) {
        if(!confirm(`Deseja alterar o status para ${newStatus}?`)) return;

        try {
            // UI Update Otimista
            const userIndex = globalContributors.findIndex(u => u.id === id);
            if(userIndex > -1) {
                globalContributors[userIndex].status = newStatus;
                renderTable(globalContributors); // Re-renderiza localmente
            }

            const res = await fetch(API_URL, { 
                method: 'POST', 
                body: JSON.stringify({ action: 'updateUserStatus', id: id, newStatus: newStatus }) 
            });
            const data = await res.json();
            
            if(data.status !== 'success') {
                alert("Erro ao salvar: " + data.message);
                loadContributors(); // Reverte em caso de erro
            }
        } catch(e) {
            alert("Erro de conexão.");
            loadContributors();
        }
    }

    function exportCSV() {
        if(globalContributors.length === 0) { alert("Nada para exportar."); return; }
        
        let csvContent = "data:text/csv;charset=utf-8,Nome,CPF,Email,WhatsApp,Status\n";
        globalContributors.forEach(row => {
            csvContent += `"${row.nome}","'${row.cpf}","${row.email}","${row.whatsapp}","${row.status}"\n`;
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "contribuintes_semadsa.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function logoutAdmin() {
        if(confirm("Sair do painel?")) {
            localStorage.removeItem('semadsa_admin');
            window.location.href = '../login_admin.html';
        }
    }

    function triggerBroadcast() {
        if(confirm("Iniciar disparo para lista de transmissão?")) {
            alert("Integração de mensagens iniciada.");
        }
    }
    // --- FUNÇÕES DE EXPORTAÇÃO FINANCEIRA ---
    async function exportRevenueCSV() {
        if(!confirm("Deseja baixar o relatório completo de arrecadação?")) return;
        
        try {
            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'getRevenueReport' }) });
            const data = await res.json();

            if(data.status === 'success') {
                if(data.lista.length === 0) { alert("Nenhuma transação registrada."); return; }

                let csvContent = "data:text/csv;charset=utf-8,Contribuinte,Data,Mes,Ano,Status,Valor\n";
                
                data.lista.forEach(row => {
                    // Formata a data para visualização (DD/MM/AAAA)
                    let dataFmt = row.data ? new Date(row.data).toLocaleDateString('pt-BR') : '-';
                    // Garante formato numérico no CSV (ex: 150.00)
                    let valorFmt = parseFloat(row.valor).toFixed(2).replace('.', ','); 

                    csvContent += `"${row.contribuinte}","${dataFmt}","${row.mes}","${row.ano}","${row.status}","${valorFmt}"\n`;
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "relatorio_arrecadacao_semadsa.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

            } else {
                alert("Erro ao gerar relatório: " + data.message);
            }
        } catch(e) {
            console.error(e);
            alert("Erro de conexão ao gerar relatório.");
        }
    }

    // --- FUNÇÕES DE GESTÃO DE ADMINISTRADORES ---
    function openNewAdminModal() {
        document.getElementById('modalNewAdmin').classList.remove('hidden');
    }

    function closeNewAdminModal() {
        document.getElementById('modalNewAdmin').classList.add('hidden');
        document.getElementById('adminNome').value = '';
        document.getElementById('adminLogin').value = '';
        document.getElementById('adminSenha').value = '';
    }

    async function handleRegisterAdmin(e) {
        e.preventDefault();
        const btn = document.getElementById('btnSaveAdmin');
        const originalText = btn.innerText;
        btn.innerText = "Salvando...";
        btn.disabled = true;

        const payload = {
            action: 'registerNewAdmin',
            nome: document.getElementById('adminNome').value,
            login: document.getElementById('adminLogin').value,
            senha: document.getElementById('adminSenha').value
        };

        try {
            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
            const data = await res.json();

            if(data.status === 'success') {
                alert("Gestor cadastrado com sucesso!");
                closeNewAdminModal();
            } else {
                alert("Erro: " + data.message);
            }
        } catch(e) {
            console.error(e);
            alert("Erro de conexão.");
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }
</script>
</body>
</html>
